(()=>{"use strict";class e{date=new Date;id=(Date.now()+"").slice(-10);constructor(e,t,s){this.coords=e,this.distance=t,this.duration=s}_setDescription(){const e=new Intl.DateTimeFormat("fa-IR",{hour:"numeric",minute:"numeric",day:"numeric",month:"long",year:"numeric"}).format(this.date);this.description=`${"running"===this.type?"دویدن":"دوچرخه سواری"} در ${e}`}}class t extends e{type="running";constructor(e,t,s,o){super(e,t,s),this.cadence=o,this.calcPace(),this._setDescription()}calcPace(){return this.pace=this.duration/this.distance,this.pace}}class s extends e{type="cycling";constructor(e,t,s,o){super(e,t,s),this.elevationGain=o,this.calcSpeed(),this._setDescription()}calcSpeed(){return this.speed=this.distance/this.duration,this.speed}}const o=new class{_setLocalStorag(e){localStorage.setItem("workouts",JSON.stringify(e))}_getLocalStorage(){const e=JSON.parse(localStorage.getItem("workouts"));if(e)return e.forEach((e=>{"running"===e.type&&Object.setPrototypeOf(e,t),"cycling"===e.type&&Object.setPrototypeOf(e,s)})),e}},a=new class{_generateMarkup(e,t){let s=`\n    <li class="workout workout__${e.type}" data-id="${e.id}">\n      <a href="#" class="workout__del"><i class="fa fa-trash"></i></a>\n      <a href="#" class="workout__change"><i class="fa fa-edit"></i></a>\n      <h2 class="workout__title">${e.description}</h2>\n      <div class="workout__detail">\n        <span class="workou_unit">km</span>\n        <span class="workou_value">${e.distance}</span>\n        <span class="workou_icon">${"running"===e.type?"🏃‍♂️":"🚲"}</span>\n      </div>\n      <div class="workout__detail">\n        <span class="workou_unit">MIN</span>\n        <span class="workou_value">${e.duration}</span>\n        <span class="workou_icon">⌚</span>\n      </div>\n    `;"running"===e.type&&(s+=`\n          <div class="workout__detail">\n          <span class="workou_unit">MIN/KM</span>\n          <span class="workou_value">${e.pace.toFixed(1)} </span>\n          <span class="workou_icon">⚡</span>\n        </div>\n        <div class="workout__detail">\n          <span class="workou_unit">SPM</span>\n          <span class="workou_value">${e.cadence} </span>\n          <span class="workou_icon">👣</span>\n        </div>\n      </li>\n      `),"cycling"===e.type&&(s+=`\n          <div class="workout__detail">\n          <span class="workou_unit">KM/H</span>\n          <span class="workou_value">${e.speed.toFixed(1)}</span>\n          <span class="workou_icon">⚡</span>\n        </div>\n        <div class="workout__detail">\n          <span class="workou_unit">M</span>\n          <span class="workou_value">${e.elevationGain}</span>\n          <span class="workou_icon">🗻</span>\n        </div>\n      </li>\n      `),t.insertAdjacentHTML("afterend",s)}},n=document.querySelector(".modal__content p"),i=document.querySelector(".workouts__container"),r=document.querySelector(".form"),l=document.querySelector(".distance__input"),d=document.querySelector(".duration__input"),c=document.querySelector(".cadence__input"),u=document.querySelector(".elevation__input"),_=document.querySelector("#type_workout"),h=document.querySelector(".modal");new class extends class{_toggleMenu=document.querySelector(".toggler__menu");_menuOverlay=document.querySelector(".menu__overlay");_closeMenuBtn=document.querySelector(".close__menu--btn");_form=document.querySelector(".form");_modalClose=document.querySelector(".modal i.fa-close");_modalDetailBtn=document.querySelector(".modal_datail_close");_modalOverlay=document.querySelector(".modal__overlay");_menu=document.querySelector(".menu");_modalDetailElem=document.querySelector(".modal__info");_modalElem=document.querySelector(".modal");_aboutAppBtn=document.querySelector(".about__app");constructor(){this._toggleMenu.addEventListener("click",this._toggleMenuHandler.bind(this)),this._menuOverlay.addEventListener("click",this._toggleMenuHandler.bind(this)),this._closeMenuBtn.addEventListener("click",this._toggleMenuHandler.bind(this)),this._modalClose.addEventListener("click",this._modalCloseHandler.bind(this)),this._modalDetailBtn.addEventListener("click",this._modalDetailClose.bind(this)),this._modalOverlay.addEventListener("click",this._modalCloseHandler.bind(this)),this._aboutAppBtn.addEventListener("click",this._modalHandler.bind(this,this._modalDetailElem)),document.addEventListener("keydown",function(e){"Escape"===e.key&&this._toggleMenuHandler()}.bind(this))}_toggleMenuHandler(){this._menu.classList.toggle("menu__isActive"),this._menuOverlay.classList.toggle("overlay--active"),this._form.classList.contains("hidden")||this._menu.classList.contains("menu__isActive")||(this._form.classList.add("hidden"),this._form.classList.add("hidden"))}_modalCloseHandler(){this._modalElem.classList.add("hidden_modal"),this._modalDetailElem.classList.add("hidden_modal"),this._modalOverlay.classList.remove("overlay--active")}_modalDetailClose(){this._modalDetailElem.classList.add("hidden_modal"),this._modalOverlay.classList.remove("overlay--active")}_modalHandler(e){e.classList.remove("hidden_modal"),this._modalOverlay.classList.add("overlay--active"),e.classList.contains("modal")&&setTimeout((()=>{e.classList.add("hidden_modal"),this._modalOverlay.classList.remove("overlay--active")}),5e3)}}{#e;#t;#s=[];#o=[];#a=13;constructor(){super(),this._getPosition(),this._getLocalStorage(),_.value="running",r.addEventListener("submit",this._newWorkout.bind(this)),i.addEventListener("click",this._moveToPopup.bind(this)),i.addEventListener("click",this._workoutElemEventhandler.bind(this)),_.addEventListener("change",this._toggleElevationField)}_newWorkout(e){const a=(...e)=>e.every((e=>Number.isFinite(e))),n=(...e)=>e.every((e=>e>0));e.preventDefault();const i=_.value,r=+l.value,m=+d.value,{lat:p,lng:v}=this.#t.latlng;let g,k,w;if("running"===i){if(w=+c.value,!a(r,m,w)||!n(r,m,w))return this._modalHandler(h);g=new t([p,v],r,m,w)}if("cycling"===i){if(k=+u.value,!a(r,m,k)||!n(r,m))return this._modalHandler(h);g=new s([p,v],r,m,k)}let y=!1;this.#o.some(((e,t)=>{if(e.coords.includes(g.coords[0]))return g=e,this.#o.splice(t,1),this.#e.removeLayer(this.#s[t]),this.#s.splice(t,1),void(y=!0)})),y&&("running"===i&&(g=new t([p,v],r,m,w)),"cycling"===i&&(g=new s([p,v],r,m,k))),this.#o.push(g),this._renderworkoutMarker(g),this._renderWorkout(g,y),this._hideForm(),this._toggleMenuHandler(),o._setLocalStorag(this.#o)}_workoutElemEventhandler(e){if(this.#e){if("fa fa-trash"===e.target.className){const t=e.target.closest(".workout"),s=this.#o.findIndex((e=>e.id===t.dataset.id));this.#o.splice(s,1),this.append(i,this.#o),o._setLocalStorag(this.#o),this.#e.removeLayer(this.#s[s]),this.#s.splice(s,1)}if("fa fa-edit"===e.target.className){r.classList.remove("hidden");const t=e.target.closest(".workout"),s=this.#o.findIndex((e=>e.id===t.dataset.id));this.#t=this.#s[s],this.#t.latlng=this.#t._latlng}}}_getPosition(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(this._loadMap.bind(this),function(){n.textContent="دسترسی به موقعیت مکانی ممکن نیست!",this._modalHandler(h)}.bind(this))}_loadMap(e){const{latitude:t,longitude:s}=e.coords,o=[t,s];this.#e=L.map("map").setView(o,this.#a),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.#e),this.#e.on("click",this._showForm.bind(this)),this.#o.forEach((e=>this._renderworkoutMarker(e)))}_renderworkoutMarker(e){const t={maxWidth:250,minWidth:100,autoClose:!1,closeOnClick:!1,className:`${e.type}-popup`};let s=L.marker(e.coords,{draggable:!0}).addTo(this.#e).bindPopup(L.popup(t)).setPopupContent(`${e.description}`).openPopup();s.on("dragend",this._newCoordsMarker.bind(this,e)),this.#s.push(s)}_newCoordsMarker(e,t){const{lat:s,lng:a}=t.target._latlng,n=[s,a];this.#o.forEach((t=>{e.id===t.id&&(t.coords=n)})),o._setLocalStorag(this.#o)}_renderWorkout(e,t=!1){t?this.append(i,this.#o):a._generateMarkup(e,r)}append(e,t){const s=i.firstElementChild;e.innerHTML="",e.appendChild(s),t.forEach((e=>a._generateMarkup(e,s)))}_moveToPopup(e){if(!this.#e)return;const t=e.target.closest(".workout");if(!t)return;const s=this.#o.find((e=>e.id===t.dataset.id));s&&this.#e.setView(s.coords,this.#a,{animate:!0,pan:{duration:1}})}_getLocalStorage(){this.#o=o._getLocalStorage(),this.#o.forEach((e=>this._renderWorkout(e)))}_showForm(e){this.#t=e,r.classList.remove("hidden"),d.focus(),this._toggleMenuHandler()}_hideForm(){l.value=d.value=u.value=c.value="",r.classList.add("hidden")}_toggleElevationField(){u.closest(".form__row").classList.toggle("form__row_hidden"),c.closest(".form__row").classList.toggle("form__row_hidden")}}})();